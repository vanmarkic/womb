---
import type { Language } from '../i18n';

interface Props {
	lang: Language;
	title: string;
}

const { lang, title } = Astro.props;
---
<!DOCTYPE html>
<html lang={lang}>
<head>
	<meta charset="utf-8" />
	<link rel="icon" type="image/svg+xml" href="/womb/favicon.svg" />
	<meta name="viewport" content="width=device-width" />
	<meta name="generator" content={Astro.generator} />
	<title>{title} | WOMB</title>
</head>
<body>
	<!-- Persistent background with blurred figures -->
	<div class="darkness-background" id="darkness-background">
		<!-- Blurred figures emerging from darkness -->
		<div class="bg-figure bg-figure-1" data-figure="1"></div>
		<div class="bg-figure bg-figure-2" data-figure="2"></div>
		<div class="bg-figure bg-figure-3" data-figure="3"></div>
		<div class="bg-figure bg-figure-4" data-figure="4"></div>
		<div class="bg-figure bg-figure-5" data-figure="5"></div>
		<div class="bg-figure bg-figure-6" data-figure="6"></div>
	</div>

	<!-- Sound toggle control -->
	<button id="sound-toggle" class="sound-toggle" aria-label="Toggle sound" title="Toggle sound">
		<svg class="sound-icon sound-on" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
			<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
			<path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
			<path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
		</svg>
		<svg class="sound-icon sound-off" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
			<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
			<line x1="23" y1="9" x2="17" y2="15"></line>
			<line x1="17" y1="9" x2="23" y2="15"></line>
		</svg>
	</button>

	<!-- Main content -->
	<div class="main-content">
		<slot />
	</div>
</body>
</html>

<style is:global>
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	html, body {
		width: 100%;
		height: 100%;
	}

	body {
		background: #0a0a0a;
		color: #e0e0e0;
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
		position: relative;
		overflow-x: hidden;
	}

	a {
		color: inherit;
		text-decoration: none;
	}

	/* Persistent background with blurred figures */
	.darkness-background {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100vh;
		background: radial-gradient(ellipse at center, #1a1a1a 0%, #0a0a0a 70%);
		overflow: hidden;
		z-index: -1;
		pointer-events: none;
	}

	/* Blurred background figures */
	.bg-figure {
		position: absolute;
		border-radius: 50%;
		filter: blur(60px);
		opacity: 0;
		background: rgba(80, 80, 90, 0.5);
		animation-timing-function: ease-in-out;
		animation-iteration-count: infinite;
		animation-direction: alternate;
	}

	.bg-figure-1 {
		width: 400px;
		height: 600px;
		top: 10%;
		left: 5%;
		background: rgba(70, 70, 85, 0.6);
		animation: bgEmerge1 12s infinite;
	}

	.bg-figure-2 {
		width: 350px;
		height: 550px;
		top: 40%;
		right: 10%;
		background: rgba(75, 75, 90, 0.5);
		animation: bgEmerge2 15s infinite;
		animation-delay: -7.5s;
	}

	.bg-figure-3 {
		width: 300px;
		height: 500px;
		bottom: 15%;
		left: 20%;
		background: rgba(65, 65, 80, 0.65);
		animation: bgEmerge3 18s infinite;
		animation-delay: -9s;
	}

	.bg-figure-4 {
		width: 450px;
		height: 650px;
		top: 25%;
		left: 45%;
		background: rgba(68, 68, 83, 0.55);
		animation: bgEmerge4 14s infinite;
		animation-delay: -3.5s;
	}

	.bg-figure-5 {
		width: 380px;
		height: 580px;
		bottom: 20%;
		right: 15%;
		background: rgba(72, 72, 87, 0.6);
		animation: bgEmerge5 16s infinite;
		animation-delay: -12s;
	}

	.bg-figure-6 {
		width: 320px;
		height: 520px;
		top: 60%;
		left: 35%;
		background: rgba(67, 67, 82, 0.58);
		animation: bgEmerge6 20s infinite;
		animation-delay: -5s;
	}

	/* Background figure animations */
	@keyframes bgEmerge1 {
		0% {
			opacity: 0;
			transform: translate(0, 0) scale(0.9);
			background: rgba(60, 60, 65, 0.4);
		}
		50% {
			opacity: 0.6;
			transform: translate(-20px, 30px) scale(1.1);
			background: rgba(120, 95, 135, 0.7);
		}
		100% {
			opacity: 0;
			transform: translate(-40px, 60px) scale(0.95);
			background: rgba(60, 60, 65, 0.4);
		}
	}

	@keyframes bgEmerge2 {
		0% {
			opacity: 0;
			transform: translate(0, 0) scale(1);
			background: rgba(60, 60, 65, 0.4);
		}
		50% {
			opacity: 0.55;
			transform: translate(30px, -25px) scale(1.05);
			background: rgba(95, 115, 140, 0.65);
		}
		100% {
			opacity: 0;
			transform: translate(60px, -50px) scale(0.9);
			background: rgba(60, 60, 65, 0.4);
		}
	}

	@keyframes bgEmerge3 {
		0% {
			opacity: 0;
			transform: translate(0, 0) scale(0.95);
			background: rgba(60, 60, 65, 0.4);
		}
		50% {
			opacity: 0.58;
			transform: translate(25px, 20px) scale(1.08);
			background: rgba(110, 125, 100, 0.68);
		}
		100% {
			opacity: 0;
			transform: translate(50px, 40px) scale(1);
			background: rgba(60, 60, 65, 0.4);
		}
	}

	@keyframes bgEmerge4 {
		0% {
			opacity: 0;
			transform: translate(0, 0) scale(1.05);
			background: rgba(60, 60, 65, 0.4);
		}
		50% {
			opacity: 0.52;
			transform: translate(-35px, -20px) scale(0.95);
			background: rgba(130, 100, 115, 0.62);
		}
		100% {
			opacity: 0;
			transform: translate(-70px, -40px) scale(1.1);
			background: rgba(60, 60, 65, 0.4);
		}
	}

	@keyframes bgEmerge5 {
		0% {
			opacity: 0;
			transform: translate(0, 0) scale(0.92);
			background: rgba(60, 60, 65, 0.4);
		}
		50% {
			opacity: 0.56;
			transform: translate(-25px, 35px) scale(1.06);
			background: rgba(125, 110, 95, 0.66);
		}
		100% {
			opacity: 0;
			transform: translate(-50px, 70px) scale(0.98);
			background: rgba(60, 60, 65, 0.4);
		}
	}

	@keyframes bgEmerge6 {
		0% {
			opacity: 0;
			transform: translate(0, 0) scale(1.02);
			background: rgba(60, 60, 65, 0.4);
		}
		50% {
			opacity: 0.54;
			transform: translate(40px, -30px) scale(0.93);
			background: rgba(105, 120, 125, 0.64);
		}
		100% {
			opacity: 0;
			transform: translate(80px, -60px) scale(1.04);
			background: rgba(60, 60, 65, 0.4);
		}
	}

	/* Sound toggle button */
	.sound-toggle {
		position: fixed;
		bottom: 2rem;
		left: 2rem;
		z-index: 1000;
		background: rgba(255, 255, 255, 0.05);
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 50%;
		width: 48px;
		height: 48px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.3s ease;
		backdrop-filter: blur(10px);
	}

	.sound-toggle:hover {
		background: rgba(255, 255, 255, 0.1);
		border-color: rgba(255, 255, 255, 0.2);
		transform: scale(1.1);
	}

	.sound-icon {
		color: rgba(255, 255, 255, 0.5);
		transition: color 0.3s ease;
	}

	.sound-toggle:hover .sound-icon {
		color: rgba(255, 255, 255, 0.8);
	}

	.sound-toggle.muted .sound-on {
		display: none;
	}

	.sound-toggle:not(.muted) .sound-off {
		display: none;
	}

	/* Main content wrapper */
	.main-content {
		position: relative;
		z-index: 1;
		min-height: 100vh;
	}

	/* Responsive adjustments */
	@media (max-width: 768px) {
		.bg-figure {
			filter: blur(60px);
		}

		.bg-figure-1, .bg-figure-2, .bg-figure-3,
		.bg-figure-4, .bg-figure-5, .bg-figure-6 {
			width: 250px;
			height: 400px;
		}

		.sound-toggle {
			bottom: 1rem;
			left: 1rem;
			width: 40px;
			height: 40px;
		}

		.sound-icon {
			width: 20px;
			height: 20px;
		}
	}
</style>

<script>
	import { AmbientSoundEngine } from '../scripts/ambient-sound';

	// Initialize ambient sound engine
	const soundEngine = new AmbientSoundEngine();
	soundEngine.init();

	// Sound state management
	const soundToggle = document.getElementById('sound-toggle');
	let isManuallyMuted = localStorage.getItem('soundMuted') === 'true';
	let isRecordingPlaying = false;

	// Apply initial state
	if (isManuallyMuted) {
		soundEngine.setMuted(true);
		if (soundToggle) {
			soundToggle.classList.add('muted');
		}
	}

	// Sound toggle button functionality
	if (soundToggle) {
		soundToggle.addEventListener('click', () => {
			isManuallyMuted = !isManuallyMuted;
			soundToggle.classList.toggle('muted');

			// Save preference
			localStorage.setItem('soundMuted', isManuallyMuted.toString());

			// Toggle ambient sound system
			// Only actually mute/unmute if no recording is playing
			if (isManuallyMuted) {
				soundEngine.setMuted(true);
			} else if (!isRecordingPlaying) {
				soundEngine.setMuted(false);
			}
		});
	}

	// Handle recording playback events
	window.addEventListener('recording-playing', () => {
		isRecordingPlaying = true;
		// Mute ambient sounds only if not already manually muted
		if (!isManuallyMuted) {
			soundEngine.setMuted(true);
		}
	});

	// When a recording pauses or ends, restore ambient sounds
	const handleRecordingStop = () => {
		isRecordingPlaying = false;
		// Restore ambient sounds only if not manually muted
		if (!isManuallyMuted) {
			soundEngine.setMuted(false);
		}
	};

	window.addEventListener('recording-paused', handleRecordingStop);
	window.addEventListener('recording-ended', handleRecordingStop);

	// Cleanup on page unload
	window.addEventListener('beforeunload', () => {
		soundEngine.destroy();
	});
</script>